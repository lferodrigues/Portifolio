<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contrato de Viagem</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./assets/css/styles-excursao.css">
</head>
<body>

  <div class="container">
    <h1>Contrato de Viagem</h1>
    <form id="travel-contract" class="contract-form">
      <label for="name">Nome:</label>
      <input type="text" id="name" placeholder="Digite seu nome" required>

      <label for="cpf">CPF:</label>
      <input type="text" id="cpf" placeholder="Digite seu CPF" required>

      <label for="contact">Contato:</label>
      <input type="text" id="contact" placeholder="Digite seu contato" required>

      <label>Excursão:</label>
      <p id="excursion-info"></p>

      <label for="signature">Assinatura:</label>
      <canvas id="signature"></canvas>
      <div class="actions">
        <button type="button" id="clear-signature">Limpar Assinatura</button>
        <button type="button" id="generate-pdf">Gerar PDF</button>
      </div>
    </form>

    <!-- Container para o visualizador do PDF -->
    <div id="pdf-container" style="display: none;">
      <iframe id="pdf-viewer" class="pdf-viewer" style="width: 100%; height: 80vh;"></iframe>
    </div>
  </div>

  <!-- Botão flutuante de WhatsApp -->
  <button class="floating-whatsapp" id="send-pdf">
    <i class="fab fa-whatsapp"></i>
  </button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyALOwBHLqnDH9e3n8Oe3lGUMCX0NMu7GZY",
      authDomain: "excursao-c53e3.firebaseapp.com",
      projectId: "excursao-c53e3",
      storageBucket: "excursao-c53e3.firebasestorage.app",
      messagingSenderId: "755186833932",
      appId: "1:755186833932:web:2d6fae30cb11610b4d6c29",
      measurementId: "G-RHDG54423J"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    const canvas = document.getElementById('signature');
    const ctx = canvas.getContext('2d');
    let isSigning = false;
    let pdfBlob;

    const resizeCanvas = () => {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
    };
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const startDrawing = (x, y) => { isSigning = true; ctx.moveTo(x, y); };
    const draw = (x, y) => { if (!isSigning) return; ctx.lineTo(x, y); ctx.stroke(); };
    const stopDrawing = () => { isSigning = false; };

    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      startDrawing(e.clientX - rect.left, e.clientY - rect.top);
    });

    canvas.addEventListener('mousemove', (e) => {
      if (!isSigning) return;
      const rect = canvas.getBoundingClientRect();
      draw(e.clientX - rect.left, e.clientY - rect.top);
    });

    canvas.addEventListener('mouseup', stopDrawing);

    document.getElementById('clear-signature').addEventListener('click', () => ctx.clearRect(0, 0, canvas.width, canvas.height));

    const excursionInfo = new URLSearchParams(window.location.search);
    document.getElementById('excursion-info').textContent = `${excursionInfo.get('name')} - Data: ${excursionInfo.get('date')} - Valor: R$ ${excursionInfo.get('price')}`;

    document.getElementById('generate-pdf').addEventListener('click', async () => {
      const name = document.getElementById('name').value;
      const cpf = document.getElementById('cpf').value;
      const contact = document.getElementById('contact').value;

      if (!name || !cpf || !contact) {
        alert("Preencha todos os campos");
        return;
      }

      const pdf = new jspdf.jsPDF();
      pdf.text(`Contrato de Viagem\n\nNome: ${name}\nCPF: ${cpf}\nContato: ${contact}`, 10, 10);

      const signatureImage = canvas.toDataURL("image/png");
      pdf.addImage(signatureImage, "PNG", 10, 50, 80, 40);

      pdfBlob = pdf.output('blob');

      const fileRef = ref(storage, `contracts/${Date.now()}_contrato.pdf`);
      try {
        await uploadBytes(fileRef, pdfBlob);
        const downloadURL = await getDownloadURL(fileRef);

        document.querySelector('.contract-form').style.display = 'none';
        document.querySelector('#pdf-container').style.display = 'block';

        const pdfViewer = document.getElementById('pdf-viewer');
        pdfViewer.src = URL.createObjectURL(pdfBlob);

        // Exibir o botão flutuante
        const sendButton = document.querySelector('.floating-whatsapp');
        sendButton.style.display = 'flex';

        sendButton.addEventListener('click', () => {
          window.open(`https://wa.me/5532998409798?text=${encodeURIComponent("Aqui está o contrato: " + downloadURL)}`);
        });

      } catch (error) {
        console.error("Erro ao salvar o PDF no Firebase:", error);
        alert("Erro ao salvar o contrato no Firebase.");
      }
    });
  </script>
</body>
</html>
